# 台球比赛系统数据迁移工具使用指南

本文档提供有关如何使用数据迁移工具从IndexedDB导出数据并导入到新的服务器端数据库的详细说明。

## 目录

1. [数据导出工具](#数据导出工具)
2. [数据导入工具](#数据导入工具)
3. [常见问题排解](#常见问题排解)

## 数据导出工具

`export_data.html`是一个简单的网页工具，用于从浏览器的IndexedDB数据库中导出用户数据到JSON文件。

### 使用方法

1. 在浏览器中打开`export_data.html`文件
2. 如果需要，可以选择导出时排除密码字段（推荐用于生产环境）
3. 如果需要，可以选择格式化JSON输出（使输出更易读）
4. 点击"导出用户数据"按钮
5. 数据将以JSON格式显示在页面中
6. 点击"下载JSON文件"按钮，将导出的数据保存到本地

### 注意事项

- 确保在进行数据导出前，用户已登录到应用程序（以确保数据库已正确初始化）
- 如果选择排除密码字段，导入时需要为用户设置新密码
- 导出的数据包含所有用户信息，包括比赛统计数据

## 数据导入工具

`import_script.js`是一个Node.js脚本，用于将导出的JSON数据导入到MySQL或MongoDB数据库中。

### 前置条件

1. 安装Node.js（建议v14或更高版本）
2. 安装所需依赖：
   ```
   npm install mysql2 mongoose bcrypt dotenv
   ```
3. 准备好导出的JSON数据文件
4. 根据您的目标数据库，创建并配置`.env`文件（参见`example.env`）

### 使用方法

1. 复制`example.env`文件并重命名为`.env`，然后根据您的数据库配置修改其中的连接信息
2. 运行导入脚本：
   ```
   node import_script.js <JSON文件路径> <数据库类型>
   ```
   
   其中：
   - `<JSON文件路径>` 是导出的JSON文件的路径
   - `<数据库类型>` 必须是 `mysql` 或 `mongodb`

   示例：
   ```
   node import_script.js ./users_data.json mysql
   ```

### 导入过程

1. 脚本将读取JSON文件并解析其中的用户数据
2. 对密码进行加密（如果JSON中包含密码字段）
3. 检查目标数据库中是否存在所需的表/集合，如不存在则创建
4. 将用户数据逐条导入到数据库中
5. 显示导入进度和结果统计

## 常见问题排解

### 导出问题

| 问题 | 可能原因 | 解决方案 |
|------|--------|---------|
| 导出按钮无反应 | IndexedDB未初始化 | 先登录应用程序，再尝试导出 |
| 导出数据为空 | 数据库名称不匹配 | 检查`export_data.html`中的数据库名称是否为"userAuth" |
| 格式化JSON失败 | 数据结构复杂或循环引用 | 取消选择"格式化JSON"选项 |

### 导入问题

| 问题 | 可能原因 | 解决方案 |
|------|--------|---------|
| 数据库连接失败 | 连接信息错误 | 检查`.env`文件中的连接参数 |
| 导入用户失败 | 用户名已存在 | 导入前清空目标数据库或使用更新操作 |
| "table not found"错误 | MySQL数据库不存在 | 确保已手动创建数据库（非表） |
| 密码加密失败 | bcrypt依赖问题 | 更新Node.js或重新安装bcrypt |

### 数据验证

导入完成后，请验证以下内容：

1. 用户数量是否与导出时相同
2. 用户名和组织信息是否正确
3. 比赛统计数据是否准确
4. 用户是否可以使用新密码登录（如果重置了密码）

如果发现任何异常，请检查导入日志和数据库错误消息，以确定问题所在。

## 后续步骤

成功完成数据迁移后，您需要：

1. 更新前端代码，使其连接到新的后端API
2. 确保所有用户都了解密码变更（如果您重置了密码）
3. 进行全面测试，确保所有功能正常运行
4. 备份原始IndexedDB数据，以防需要恢复 